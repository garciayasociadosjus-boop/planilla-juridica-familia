<script>
    // --- Tus claves y configuración ---
    const CLIENT_ID = '976943805178-1r5pvivhpstfnjp41eoolopo0kvb1cif.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDSMwMM31JM4ZNqRezhH-8uxaE1GVOjrrM';
    const FOLDER_ID = '15YqcN5SUx-Ba4vqy0ey9eubVQuh3XoVP'; // <-- El ID de tu carpeta "Planillas Jurídicas"
    
    // --- Constantes de la API de Google ---
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const fileName = 'planilla_datos.json';
    
    // --- Variables de estado ---
    let tokenClient;

    // --- Funciones de Carga e Inicio ---
    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: DISCOVERY_DOCS,
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // Se define dinámicamente
        });
    }

    // --- Funciones de Autenticación y Botones ---
    function handleAuthClick() {
        tokenClient.callback = async (resp) => {
            if (resp.error !== undefined) {
                throw (resp);
            }
            document.getElementById('signout_button').style.visibility = 'visible';
            document.getElementById('authorize_button').style.visibility = 'hidden';
            await loadData();
        };

        if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
            tokenClient.requestAccessToken({prompt: ''});
        }
    }

    function handleSignOutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
            google.accounts.oauth2.revoke(token.access_token);
            gapi.client.setToken('');
            document.getElementById('dataForm').reset();
            document.getElementById('status').textContent = 'Sesión cerrada. Conéctate para empezar.';
            document.getElementById('authorize_button').style.visibility = 'visible';
            document.getElementById('signout_button').style.visibility = 'hidden';
        }
    }

    // --- Funciones de Datos (Cargar y Guardar) ---
    async function loadData() {
        try {
            document.getElementById('status').textContent = 'Buscando archivo en Drive...';
            // Buscar el archivo SÓLO dentro de la carpeta especificada
            const response = await gapi.client.drive.files.list({
                q: `name='${fileName}' and '${FOLDER_ID}' in parents and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });

            if (response.result.files.length > 0) {
                const fileId = response.result.files[0].id;
                document.getElementById('dataForm').setAttribute('data-file-id', fileId);
                
                const fileResponse = await gapi.client.drive.files.get({
                    fileId: fileId,
                    alt: 'media'
                });
                
                const data = JSON.parse(fileResponse.body);
                for (const key in data) {
                    if (document.getElementById(key)) {
                        document.getElementById(key).value = data[key];
                    }
                }
                document.getElementById('status').textContent = 'Datos cargados desde la carpeta correcta.';
            } else {
                document.getElementById('status').textContent = 'Archivo no encontrado. Se creará uno nuevo al guardar.';
                document.getElementById('dataForm').removeAttribute('data-file-id');
            }
        } catch (err) {
            document.getElementById('status').textContent = 'Error al cargar datos: ' + err.message;
            console.error(err);
        }
    }

    async function saveData(event) {
        event.preventDefault();
        document.getElementById('status').textContent = 'Guardando...';

        const data = {
            expediente: document.getElementById('expediente').value,
            causa: document.getElementById('causa').value,
            juzgado: document.getElementById('juzgado').value,
            actor: document.getElementById('actor').value,
            demandado: document.getElementById('demandado').value,
            fecha_inicio: document.getElementById('fecha_inicio').value,
            estado: document.getElementById('estado').value,
            proximo_paso: document.getElementById('proximo_paso').value,
            fecha_vencimiento: document.getElementById('fecha_vencimiento').value,
            observaciones: document.getElementById('observaciones').value,
        };

        const fileContent = JSON.stringify(data, null, 2);
        const file = new Blob([fileContent], {type: 'application/json'});
        const fileId = document.getElementById('dataForm').getAttribute('data-file-id');

        const metadata = {
            name: fileName,
            mimeType: 'application/json',
        };
        
        const formData = new FormData();

        try {
            if (fileId) { // Si el archivo YA EXISTE, lo actualizamos
                 formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                 formData.append('file', file);

                 await gapi.client.request({
                    path: `/upload/drive/v3/files/${fileId}`,
                    method: 'PATCH',
                    params: { uploadType: 'multipart' },
                    body: formData
                });
                document.getElementById('status').textContent = '¡Datos actualizados en Drive!';

            } else { // Si el archivo NO EXISTE, lo creamos en la carpeta correcta
                metadata.parents = [FOLDER_ID]; // <-- La magia está aquí
                formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                formData.append('file', file);
                
                const response = await gapi.client.request({
                    path: '/upload/drive/v3/files',
                    method: 'POST',
                    params: { uploadType: 'multipart' },
                    body: formData
                });
                document.getElementById('dataForm').setAttribute('data-file-id', response.result.id);
                document.getElementById('status').textContent = '¡Archivo creado y guardado en Drive!';
            }
        } catch (err) {
            document.getElementById('status').textContent = 'Error al guardar: ' + err.message;
            console.error(err);
        }
    }
</script>

<!-- Scripts de Google que deben ir al final -->
<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
